<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-comment">-- Copyright 2021 Google LLC</span><span>
</span><span id="line-2"></span><span class="hs-comment">--</span><span>
</span><span id="line-3"></span><span class="hs-comment">-- Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><span>
</span><span id="line-4"></span><span class="hs-comment">-- you may not use this file except in compliance with the License.</span><span>
</span><span id="line-5"></span><span class="hs-comment">-- You may obtain a copy of the License at</span><span>
</span><span id="line-6"></span><span class="hs-comment">--</span><span>
</span><span id="line-7"></span><span class="hs-comment">--      http://www.apache.org/licenses/LICENSE-2.0</span><span>
</span><span id="line-8"></span><span class="hs-comment">--</span><span>
</span><span id="line-9"></span><span class="hs-comment">-- Unless required by applicable law or agreed to in writing, software</span><span>
</span><span id="line-10"></span><span class="hs-comment">-- distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><span>
</span><span id="line-11"></span><span class="hs-comment">-- WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><span>
</span><span id="line-12"></span><span class="hs-comment">-- See the License for the specific language governing permissions and</span><span>
</span><span id="line-13"></span><span class="hs-comment">-- limitations under the License.</span><span>
</span><span id="line-14"></span><span>
</span><span id="line-15"></span><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">MLIR.AST.Rewrite</span><span>
</span><span id="line-16"></span><span>  </span><span class="hs-special">(</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#RewriteBuilderT"><span class="hs-identifier">RewriteBuilderT</span></a></span><span>
</span><span id="line-17"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#OpRewriteM"><span class="hs-identifier">OpRewriteM</span></a></span><span>
</span><span id="line-18"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#OpRewrite"><span class="hs-identifier">OpRewrite</span></a></span><span>
</span><span id="line-19"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#RewriteResult"><span class="hs-identifier">RewriteResult</span></a></span><span class="hs-special">(</span><span class="hs-glyph">..</span><span class="hs-special">)</span><span>
</span><span id="line-20"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-keyword">pattern</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#ReplaceOne"><span class="hs-identifier">ReplaceOne</span></a></span><span>
</span><span id="line-21"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#applyClosedOpRewrite"><span class="hs-identifier">applyClosedOpRewrite</span></a></span><span>
</span><span id="line-22"></span><span>  </span><span class="hs-special">,</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#applyClosedOpRewriteT"><span class="hs-identifier">applyClosedOpRewriteT</span></a></span><span>
</span><span id="line-23"></span><span>  </span><span class="hs-special">)</span><span> </span><span class="hs-keyword">where</span><span>
</span><span id="line-24"></span><span>
</span><span id="line-25"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><span class="hs-identifier">Data.Map.Strict</span></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">M</span></span><span>
</span><span id="line-26"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Reader</span></span><span>
</span><span id="line-27"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><span class="hs-identifier">Control.Monad.Identity</span></span><span>
</span><span id="line-28"></span><span>
</span><span id="line-29"></span><span class="hs-keyword">import</span><span> </span><span class="hs-keyword">qualified</span><span> </span><span class="annot"><a href="MLIR.AST.html"><span class="hs-identifier">MLIR.AST</span></a></span><span> </span><span class="hs-keyword">as</span><span> </span><span class="annot"><span class="hs-identifier">AST</span></span><span>
</span><span id="line-30"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="MLIR.AST.html"><span class="hs-identifier">MLIR.AST</span></a></span><span> </span><span class="hs-keyword">hiding</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="MLIR.AST.html#Operation"><span class="hs-identifier">Operation</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-31"></span><span class="hs-keyword">import</span><span> </span><span class="annot"><a href="MLIR.AST.Builder.html"><span class="hs-identifier">MLIR.AST.Builder</span></a></span><span>
</span><span id="line-32"></span><span>
</span><span id="line-33"></span><span class="hs-comment">-- For convenience we pass in operations with operands already substituted</span><span>
</span><span id="line-34"></span><span class="hs-comment">-- for builder-compilant values that can be used to replace the operation</span><span>
</span><span id="line-35"></span><span class="hs-comment">-- with an arbitrary program constructed through a builder expression.</span><span>
</span><span id="line-36"></span><span class="hs-keyword">type</span><span> </span><span id="Operation"><span class="annot"><a href="MLIR.AST.Rewrite.html#Operation"><span class="hs-identifier hs-var">Operation</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="MLIR.AST.html#AbstractOperation"><span class="hs-identifier hs-type">AST.AbstractOperation</span></a></span><span> </span><span class="annot"><a href="MLIR.AST.Builder.html#Value"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-37"></span><span>
</span><span id="line-38"></span><span class="hs-keyword">type</span><span> </span><span id="ValueMapping"><span class="annot"><a href="MLIR.AST.Rewrite.html#ValueMapping"><span class="hs-identifier hs-var">ValueMapping</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="MLIR.AST.html#Name"><span class="hs-identifier hs-type">Name</span></a></span><span>      </span><span class="annot"><a href="MLIR.AST.Builder.html#Value"><span class="hs-identifier hs-type">Value</span></a></span><span>
</span><span id="line-39"></span><span class="hs-keyword">type</span><span> </span><span id="BlockMapping"><span class="annot"><a href="MLIR.AST.Rewrite.html#BlockMapping"><span class="hs-identifier hs-var">BlockMapping</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">M.Map</span></span><span> </span><span class="annot"><a href="MLIR.AST.Builder.html#BlockName"><span class="hs-identifier hs-type">BlockName</span></a></span><span> </span><span class="annot"><a href="MLIR.AST.Builder.html#BlockName"><span class="hs-identifier hs-type">BlockName</span></a></span><span>
</span><span id="line-40"></span><span class="hs-keyword">type</span><span> </span><span id="BlockAndValueMapping"><span class="annot"><a href="MLIR.AST.Rewrite.html#BlockAndValueMapping"><span class="hs-identifier hs-var">BlockAndValueMapping</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-special">(</span><span class="annot"><a href="MLIR.AST.Rewrite.html#ValueMapping"><span class="hs-identifier hs-type">ValueMapping</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#BlockMapping"><span class="hs-identifier hs-type">BlockMapping</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-41"></span><span>
</span><span id="line-42"></span><span class="hs-keyword">type</span><span> </span><span id="SubstT"><span class="annot"><a href="MLIR.AST.Rewrite.html#SubstT"><span class="hs-identifier hs-var">SubstT</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="hs-identifier hs-type">ReaderT</span></span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#BlockAndValueMapping"><span class="hs-identifier hs-type">BlockAndValueMapping</span></a></span><span>
</span><span id="line-43"></span><span class="hs-keyword">type</span><span> </span><span id="RewriteT"><span class="annot"><a href="MLIR.AST.Rewrite.html#RewriteT"><span class="hs-identifier hs-var">RewriteT</span></a></span></span><span> </span><span id="local-6989586621679447367"><span class="annot"><a href="#local-6989586621679447367"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#SubstT"><span class="hs-identifier hs-type">SubstT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="MLIR.AST.Builder.html#NameSupplyT"><span class="hs-identifier hs-type">NameSupplyT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447367"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-44"></span><span class="hs-keyword">type</span><span> </span><span id="RewriteBuilderT"><span class="annot"><a href="MLIR.AST.Rewrite.html#RewriteBuilderT"><span class="hs-identifier hs-var">RewriteBuilderT</span></a></span></span><span> </span><span id="local-6989586621679447366"><span class="annot"><a href="#local-6989586621679447366"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="MLIR.AST.Builder.html#BlockBuilderT"><span class="hs-identifier hs-type">BlockBuilderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="MLIR.AST.Rewrite.html#RewriteT"><span class="hs-identifier hs-type">RewriteT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447366"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-45"></span><span>
</span><span id="line-46"></span><span class="hs-keyword">data</span><span> </span><span id="RewriteResult"><span class="annot"><a href="MLIR.AST.Rewrite.html#RewriteResult"><span class="hs-identifier hs-var">RewriteResult</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span id="Replace"><span class="annot"><a href="MLIR.AST.Rewrite.html#Replace"><span class="hs-identifier hs-var">Replace</span></a></span></span><span> </span><span class="hs-special">[</span><span class="annot"><a href="MLIR.AST.Builder.html#Value"><span class="hs-identifier hs-type">Value</span></a></span><span class="hs-special">]</span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Skip"><span class="annot"><a href="MLIR.AST.Rewrite.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span></span><span> </span><span class="hs-glyph">|</span><span> </span><span id="Traverse"><span class="annot"><a href="MLIR.AST.Rewrite.html#Traverse"><span class="hs-identifier hs-var">Traverse</span></a></span></span><span>
</span><span id="line-47"></span><span>
</span><span id="line-48"></span><span class="hs-keyword">pattern</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#ReplaceOne"><span class="hs-identifier hs-type">ReplaceOne</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="MLIR.AST.Builder.html#Value"><span class="hs-identifier hs-type">Value</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#RewriteResult"><span class="hs-identifier hs-type">RewriteResult</span></a></span><span>
</span><span id="line-49"></span><span class="hs-keyword">pattern</span><span> </span><span id="%24bReplaceOne"><span id="%24mReplaceOne"><span id="ReplaceOne"><span class="annot"><span class="annottext">$bReplaceOne :: Value -&gt; RewriteResult
$mReplaceOne :: forall r. RewriteResult -&gt; (Value -&gt; r) -&gt; (Void# -&gt; r) -&gt; r
</span><a href="MLIR.AST.Rewrite.html#%24bReplaceOne"><span class="hs-identifier hs-var hs-var hs-var">ReplaceOne</span></a></span></span></span></span><span> </span><span class="annot"><a href="#local-6989586621679447360"><span class="hs-identifier hs-type">val</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#Replace"><span class="hs-identifier hs-type">Replace</span></a></span><span> </span><span class="hs-special">[</span><span id="local-6989586621679447360"><span class="annot"><a href="#local-6989586621679447360"><span class="hs-identifier hs-var">val</span></a></span></span><span class="hs-special">]</span><span>
</span><span id="line-50"></span><span>
</span><span id="line-51"></span><span class="hs-keyword">type</span><span> </span><span id="OpRewriteM"><span class="annot"><a href="MLIR.AST.Rewrite.html#OpRewriteM"><span class="hs-identifier hs-var">OpRewriteM</span></a></span></span><span> </span><span id="local-6989586621679447359"><span class="annot"><a href="#local-6989586621679447359"><span class="hs-identifier hs-type">m</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#Operation"><span class="hs-identifier hs-type">Operation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#RewriteBuilderT"><span class="hs-identifier hs-type">RewriteBuilderT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447359"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#RewriteResult"><span class="hs-identifier hs-type">RewriteResult</span></a></span><span>
</span><span id="line-52"></span><span class="hs-keyword">type</span><span> </span><span id="OpRewrite"><span class="annot"><a href="MLIR.AST.Rewrite.html#OpRewrite"><span class="hs-identifier hs-var">OpRewrite</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#OpRewriteM"><span class="hs-identifier hs-type">OpRewriteM</span></a></span><span> </span><span class="annot"><span class="hs-identifier hs-type">Identity</span></span><span>
</span><span id="line-53"></span><span>
</span><span id="line-54"></span><span id="local-6989586621679447404"><span id="local-6989586621679447405"><span class="annot"><a href="MLIR.AST.Rewrite.html#extendValueMap"><span class="hs-identifier hs-type">extendValueMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#BlockAndValueMapping"><span class="hs-identifier hs-type">BlockAndValueMapping</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447405"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#ValueMapping"><span class="hs-identifier hs-type">ValueMapping</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679447405"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447404"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679447405"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447404"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-55"></span><span id="extendValueMap"><span class="annot"><span class="annottext">extendValueMap :: ValueMapping -&gt; m a -&gt; m a
</span><a href="MLIR.AST.Rewrite.html#extendValueMap"><span class="hs-identifier hs-var hs-var">extendValueMap</span></a></span></span><span> </span><span id="local-6989586621679447357"><span class="annot"><span class="annottext">ValueMapping
</span><a href="#local-6989586621679447357"><span class="hs-identifier hs-var">upd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((ValueMapping, BlockMapping) -&gt; (ValueMapping, BlockMapping))
-&gt; m a -&gt; m a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679447355"><span class="annot"><span class="annottext">ValueMapping
</span><a href="#local-6989586621679447355"><span class="hs-identifier hs-var">vm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679447354"><span class="annot"><span class="annottext">BlockMapping
</span><a href="#local-6989586621679447354"><span class="hs-identifier hs-var">bm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValueMapping
</span><a href="#local-6989586621679447355"><span class="hs-identifier hs-var">vm</span></a></span><span> </span><span class="annot"><span class="annottext">ValueMapping -&gt; ValueMapping -&gt; ValueMapping
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">ValueMapping
</span><a href="#local-6989586621679447357"><span class="hs-identifier hs-var">upd</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockMapping
</span><a href="#local-6989586621679447354"><span class="hs-identifier hs-var">bm</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-56"></span><span>
</span><span id="line-57"></span><span id="local-6989586621679447421"><span id="local-6989586621679447422"><span class="annot"><a href="MLIR.AST.Rewrite.html#extendBlockMap"><span class="hs-identifier hs-type">extendBlockMap</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#BlockAndValueMapping"><span class="hs-identifier hs-type">BlockAndValueMapping</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447422"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#BlockMapping"><span class="hs-identifier hs-type">BlockMapping</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679447422"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447421"><span class="hs-identifier hs-type">a</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679447422"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447421"><span class="hs-identifier hs-type">a</span></a></span></span></span><span>
</span><span id="line-58"></span><span id="extendBlockMap"><span class="annot"><span class="annottext">extendBlockMap :: BlockMapping -&gt; m a -&gt; m a
</span><a href="MLIR.AST.Rewrite.html#extendBlockMap"><span class="hs-identifier hs-var hs-var">extendBlockMap</span></a></span></span><span> </span><span id="local-6989586621679447352"><span class="annot"><span class="annottext">BlockMapping
</span><a href="#local-6989586621679447352"><span class="hs-identifier hs-var">upd</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">((ValueMapping, BlockMapping) -&gt; (ValueMapping, BlockMapping))
-&gt; m a -&gt; m a
forall r (m :: * -&gt; *) a. MonadReader r m =&gt; (r -&gt; r) -&gt; m a -&gt; m a
</span><span class="hs-identifier hs-var">local</span></span><span> </span><span class="hs-glyph">\</span><span class="hs-special">(</span><span id="local-6989586621679447351"><span class="annot"><span class="annottext">ValueMapping
</span><a href="#local-6989586621679447351"><span class="hs-identifier hs-var">vm</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679447350"><span class="annot"><span class="annottext">BlockMapping
</span><a href="#local-6989586621679447350"><span class="hs-identifier hs-var">bm</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValueMapping
</span><a href="#local-6989586621679447351"><span class="hs-identifier hs-var">vm</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockMapping
</span><a href="#local-6989586621679447350"><span class="hs-identifier hs-var">bm</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMapping -&gt; BlockMapping -&gt; BlockMapping
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">BlockMapping
</span><a href="#local-6989586621679447352"><span class="hs-identifier hs-var">upd</span></a></span><span class="hs-special">)</span><span>
</span><span id="line-59"></span><span>
</span><span id="line-60"></span><span class="annot"><a href="MLIR.AST.Rewrite.html#applyClosedOpRewrite"><span class="hs-identifier hs-type">applyClosedOpRewrite</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#OpRewrite"><span class="hs-identifier hs-type">OpRewrite</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.html#Operation"><span class="hs-identifier hs-type">AST.Operation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.html#Operation"><span class="hs-identifier hs-type">AST.Operation</span></a></span><span>
</span><span id="line-61"></span><span id="applyClosedOpRewrite"><span class="annot"><span class="annottext">applyClosedOpRewrite :: OpRewrite -&gt; Operation -&gt; Operation
</span><a href="MLIR.AST.Rewrite.html#applyClosedOpRewrite"><span class="hs-identifier hs-var hs-var">applyClosedOpRewrite</span></a></span></span><span> </span><span id="local-6989586621679447349"><span class="annot"><span class="annottext">OpRewrite
</span><a href="#local-6989586621679447349"><span class="hs-identifier hs-var">rule</span></a></span></span><span> </span><span id="local-6989586621679447348"><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447348"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">Identity Operation -&gt; Operation
forall a. Identity a -&gt; a
</span><span class="hs-identifier hs-var hs-var">runIdentity</span></span><span> </span><span class="annot"><span class="annottext">(Identity Operation -&gt; Operation)
-&gt; Identity Operation -&gt; Operation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OpRewrite -&gt; Operation -&gt; Identity Operation
forall (m :: * -&gt; *).
MonadFix m =&gt;
OpRewriteM m -&gt; Operation -&gt; m Operation
</span><a href="MLIR.AST.Rewrite.html#applyClosedOpRewriteT"><span class="hs-identifier hs-var">applyClosedOpRewriteT</span></a></span><span> </span><span class="annot"><span class="annottext">OpRewrite
</span><a href="#local-6989586621679447349"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447348"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-62"></span><span>
</span><span id="line-63"></span><span id="local-6989586621679447457"><span class="annot"><a href="MLIR.AST.Rewrite.html#applyClosedOpRewriteT"><span class="hs-identifier hs-type">applyClosedOpRewriteT</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadFix</span></span><span> </span><span class="annot"><a href="#local-6989586621679447457"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#OpRewriteM"><span class="hs-identifier hs-type">OpRewriteM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447457"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.html#Operation"><span class="hs-identifier hs-type">AST.Operation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679447457"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="MLIR.AST.html#Operation"><span class="hs-identifier hs-type">AST.Operation</span></a></span></span><span>
</span><span id="line-64"></span><span id="applyClosedOpRewriteT"><span class="annot"><span class="annottext">applyClosedOpRewriteT :: OpRewriteM m -&gt; Operation -&gt; m Operation
</span><a href="MLIR.AST.Rewrite.html#applyClosedOpRewriteT"><span class="hs-identifier hs-var hs-var">applyClosedOpRewriteT</span></a></span></span><span> </span><span id="local-6989586621679447346"><span class="annot"><span class="annottext">OpRewriteM m
</span><a href="#local-6989586621679447346"><span class="hs-identifier hs-var">rule</span></a></span></span><span> </span><span id="local-6989586621679447345"><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447345"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">NameSupplyT m Operation -&gt; m Operation
forall (m :: * -&gt; *) a. Monad m =&gt; NameSupplyT m a -&gt; m a
</span><a href="MLIR.AST.Builder.html#evalNameSupplyT"><span class="hs-identifier hs-var">evalNameSupplyT</span></a></span><span> </span><span class="annot"><span class="annottext">(NameSupplyT m Operation -&gt; m Operation)
-&gt; NameSupplyT m Operation -&gt; m Operation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">OpRewriteM m -&gt; Operation -&gt; NameSupplyT m Operation
forall (m :: * -&gt; *).
MonadFix m =&gt;
OpRewriteM m -&gt; Operation -&gt; NameSupplyT m Operation
</span><a href="MLIR.AST.Rewrite.html#applyOpRewrite"><span class="hs-identifier hs-var">applyOpRewrite</span></a></span><span> </span><span class="annot"><span class="annottext">OpRewriteM m
</span><a href="#local-6989586621679447346"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447345"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-65"></span><span>
</span><span id="line-66"></span><span id="local-6989586621679447451"><span class="annot"><a href="MLIR.AST.Rewrite.html#applyOpRewrite"><span class="hs-identifier hs-type">applyOpRewrite</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadFix</span></span><span> </span><span class="annot"><a href="#local-6989586621679447451"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#OpRewriteM"><span class="hs-identifier hs-type">OpRewriteM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447451"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.html#Operation"><span class="hs-identifier hs-type">AST.Operation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.Builder.html#NameSupplyT"><span class="hs-identifier hs-type">NameSupplyT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447451"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="MLIR.AST.html#Operation"><span class="hs-identifier hs-type">AST.Operation</span></a></span></span><span>
</span><span id="line-67"></span><span id="applyOpRewrite"><span class="annot"><span class="annottext">applyOpRewrite :: OpRewriteM m -&gt; Operation -&gt; NameSupplyT m Operation
</span><a href="MLIR.AST.Rewrite.html#applyOpRewrite"><span class="hs-identifier hs-var hs-var">applyOpRewrite</span></a></span></span><span> </span><span id="local-6989586621679447342"><span class="annot"><span class="annottext">OpRewriteM m
</span><a href="#local-6989586621679447342"><span class="hs-identifier hs-var">rule</span></a></span></span><span> </span><span id="local-6989586621679447341"><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447341"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) Operation
 -&gt; (ValueMapping, BlockMapping) -&gt; NameSupplyT m Operation)
-&gt; (ValueMapping, BlockMapping)
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) Operation
-&gt; NameSupplyT m Operation
forall a b c. (a -&gt; b -&gt; c) -&gt; b -&gt; a -&gt; c
</span><span class="hs-identifier hs-var">flip</span></span><span> </span><span class="annot"><span class="annottext">ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) Operation
-&gt; (ValueMapping, BlockMapping) -&gt; NameSupplyT m Operation
forall r (m :: * -&gt; *) a. ReaderT r m a -&gt; r -&gt; m a
</span><span class="hs-identifier hs-var hs-var">runReaderT</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValueMapping
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">BlockMapping
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) Operation
 -&gt; NameSupplyT m Operation)
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) Operation
-&gt; NameSupplyT m Operation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-68"></span><span>  </span><span id="local-6989586621679447338"><span class="annot"><span class="annottext">[Region]
</span><a href="#local-6989586621679447338"><span class="hs-identifier hs-var">newRegions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Region
 -&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) Region)
-&gt; [Region]
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OpRewriteM m
-&gt; Region
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) Region
forall (m :: * -&gt; *).
MonadFix m =&gt;
OpRewriteM m -&gt; Region -&gt; RewriteT m Region
</span><a href="MLIR.AST.Rewrite.html#applyOpRewriteRegion"><span class="hs-identifier hs-var">applyOpRewriteRegion</span></a></span><span> </span><span class="annot"><span class="annottext">OpRewriteM m
</span><a href="#local-6989586621679447342"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Region]
 -&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region])
-&gt; [Region]
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operation -&gt; [Region]
forall operand. AbstractOperation operand -&gt; [Region]
</span><a href="MLIR.AST.html#opRegions"><span class="hs-identifier hs-var hs-var">opRegions</span></a></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447341"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-69"></span><span>  </span><span class="annot"><span class="annottext">Operation
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) Operation
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Operation
 -&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) Operation)
-&gt; Operation
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) Operation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447341"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">opRegions :: [Region]
</span><a href="MLIR.AST.html#opRegions"><span class="hs-identifier hs-var">opRegions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Region]
</span><a href="#local-6989586621679447338"><span class="hs-identifier hs-var">newRegions</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-70"></span><span>
</span><span id="line-71"></span><span id="local-6989586621679447436"><span class="annot"><a href="MLIR.AST.Rewrite.html#applyOpRewriteRegion"><span class="hs-identifier hs-type">applyOpRewriteRegion</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadFix</span></span><span> </span><span class="annot"><a href="#local-6989586621679447436"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#OpRewriteM"><span class="hs-identifier hs-type">OpRewriteM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447436"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.html#Region"><span class="hs-identifier hs-type">Region</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#RewriteT"><span class="hs-identifier hs-type">RewriteT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447436"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="MLIR.AST.html#Region"><span class="hs-identifier hs-type">Region</span></a></span></span><span>
</span><span id="line-72"></span><span id="applyOpRewriteRegion"><span class="annot"><span class="annottext">applyOpRewriteRegion :: OpRewriteM m -&gt; Region -&gt; RewriteT m Region
</span><a href="MLIR.AST.Rewrite.html#applyOpRewriteRegion"><span class="hs-identifier hs-var hs-var">applyOpRewriteRegion</span></a></span></span><span> </span><span id="local-6989586621679447334"><span class="annot"><span class="annottext">OpRewriteM m
</span><a href="#local-6989586621679447334"><span class="hs-identifier hs-var">rule</span></a></span></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="MLIR.AST.html#Region"><span class="hs-identifier hs-type">Region</span></a></span><span> </span><span id="local-6989586621679447332"><span class="annot"><span class="annottext">[Block]
</span><a href="#local-6989586621679447332"><span class="hs-identifier hs-var">blocks</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-73"></span><span>  </span><span class="annot"><span class="annottext">RegionBuilderT (RewriteT m) () -&gt; RewriteT m Region
forall (m :: * -&gt; *). Monad m =&gt; RegionBuilderT m () -&gt; m Region
</span><a href="MLIR.AST.Builder.html#buildRegion"><span class="hs-identifier hs-var">buildRegion</span></a></span><span> </span><span class="annot"><span class="annottext">(RegionBuilderT (RewriteT m) () -&gt; RewriteT m Region)
-&gt; RegionBuilderT (RewriteT m) () -&gt; RewriteT m Region
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RegionBuilderT (RewriteT m) BlockMapping
-&gt; RegionBuilderT (RewriteT m) ()
forall (f :: * -&gt; *) a. Functor f =&gt; f a -&gt; f ()
</span><span class="hs-identifier hs-var">void</span></span><span> </span><span class="annot"><span class="annottext">(RegionBuilderT (RewriteT m) BlockMapping
 -&gt; RegionBuilderT (RewriteT m) ())
-&gt; RegionBuilderT (RewriteT m) BlockMapping
-&gt; RegionBuilderT (RewriteT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(BlockMapping -&gt; RegionBuilderT (RewriteT m) BlockMapping)
-&gt; RegionBuilderT (RewriteT m) BlockMapping
forall (m :: * -&gt; *) a. MonadFix m =&gt; (a -&gt; m a) -&gt; m a
</span><span class="hs-identifier hs-var">mfix</span></span><span> </span><span class="hs-glyph">\</span><span id="local-6989586621679447329"><span class="annot"><span class="annottext">BlockMapping
</span><a href="#local-6989586621679447329"><span class="hs-identifier hs-var">blockSubst</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BlockMapping
-&gt; RegionBuilderT (RewriteT m) BlockMapping
-&gt; RegionBuilderT (RewriteT m) BlockMapping
forall (m :: * -&gt; *) a.
MonadReader (ValueMapping, BlockMapping) m =&gt;
BlockMapping -&gt; m a -&gt; m a
</span><a href="MLIR.AST.Rewrite.html#extendBlockMap"><span class="hs-identifier hs-var">extendBlockMap</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMapping
</span><a href="#local-6989586621679447329"><span class="hs-identifier hs-var">blockSubst</span></a></span><span> </span><span class="annot"><span class="annottext">(RegionBuilderT (RewriteT m) BlockMapping
 -&gt; RegionBuilderT (RewriteT m) BlockMapping)
-&gt; RegionBuilderT (RewriteT m) BlockMapping
-&gt; RegionBuilderT (RewriteT m) BlockMapping
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">BlockMapping -&gt; [Block] -&gt; RegionBuilderT (RewriteT m) BlockMapping
</span><a href="#local-6989586621679447328"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMapping
forall a. Monoid a =&gt; a
</span><span class="hs-identifier hs-var">mempty</span></span><span> </span><span class="annot"><span class="annottext">[Block]
</span><a href="#local-6989586621679447332"><span class="hs-identifier hs-var">blocks</span></a></span><span>
</span><span id="line-74"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-75"></span><span>    </span><span id="local-6989586621679447328"><span class="annot"><span class="annottext">go :: BlockMapping -&gt; [Block] -&gt; RegionBuilderT (RewriteT m) BlockMapping
</span><a href="#local-6989586621679447328"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679447327"><span class="annot"><span class="annottext">BlockMapping
</span><a href="#local-6989586621679447327"><span class="hs-identifier hs-var">blockSubst</span></a></span></span><span> </span><span id="local-6989586621679447326"><span class="annot"><span class="annottext">[Block]
</span><a href="#local-6989586621679447326"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Block]
</span><a href="#local-6989586621679447326"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-76"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span>                                 </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BlockMapping -&gt; RegionBuilderT (RewriteT m) BlockMapping
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">BlockMapping
</span><a href="#local-6989586621679447327"><span class="hs-identifier hs-var">blockSubst</span></a></span><span>
</span><span id="line-77"></span><span>      </span><span class="hs-special">(</span><span id="local-6989586621679447325"><span class="annot"><span class="annottext">block :: Block
</span><a href="#local-6989586621679447325"><span class="hs-identifier hs-var">block</span></a></span></span><span class="hs-glyph">@</span><span class="hs-special">(</span><span class="annot"><a href="MLIR.AST.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span id="local-6989586621679447323"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679447323"><span class="hs-identifier hs-var">oldName</span></a></span></span><span> </span><span class="annot"><span class="annottext">[(Name, Type)]
</span><span class="hs-identifier">_</span></span><span> </span><span class="annot"><span class="annottext">[Binding]
</span><span class="hs-identifier">_</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679447322"><span class="annot"><span class="annottext">[Block]
</span><a href="#local-6989586621679447322"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-78"></span><span>        </span><span id="local-6989586621679447321"><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679447321"><span class="hs-identifier hs-var">newName</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OpRewriteM m -&gt; Block -&gt; RegionBuilderT (RewriteT m) Name
forall (m :: * -&gt; *).
MonadFix m =&gt;
OpRewriteM m -&gt; Block -&gt; RegionBuilderT (RewriteT m) Name
</span><a href="MLIR.AST.Rewrite.html#applyOpRewriteBlock"><span class="hs-identifier hs-var">applyOpRewriteBlock</span></a></span><span> </span><span class="annot"><span class="annottext">OpRewriteM m
</span><a href="#local-6989586621679447334"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="annot"><span class="annottext">Block
</span><a href="#local-6989586621679447325"><span class="hs-identifier hs-var">block</span></a></span><span>
</span><span id="line-79"></span><span>        </span><span class="annot"><span class="annottext">BlockMapping -&gt; [Block] -&gt; RegionBuilderT (RewriteT m) BlockMapping
</span><a href="#local-6989586621679447328"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockMapping
</span><a href="#local-6989586621679447327"><span class="hs-identifier hs-var">blockSubst</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMapping -&gt; BlockMapping -&gt; BlockMapping
forall a. Semigroup a =&gt; a -&gt; a -&gt; a
</span><span class="hs-operator hs-var">&lt;&gt;</span></span><span> </span><span class="annot"><span class="annottext">Name -&gt; Name -&gt; BlockMapping
forall k a. k -&gt; a -&gt; Map k a
</span><span class="hs-identifier hs-var">M.singleton</span></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679447323"><span class="hs-identifier hs-var">oldName</span></a></span><span> </span><span class="annot"><span class="annottext">Name
</span><a href="#local-6989586621679447321"><span class="hs-identifier hs-var">newName</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">[Block]
</span><a href="#local-6989586621679447322"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-80"></span><span>
</span><span id="line-81"></span><span id="local-6989586621679447417"><span class="annot"><a href="MLIR.AST.Rewrite.html#applyOpRewriteBlock"><span class="hs-identifier hs-type">applyOpRewriteBlock</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadFix</span></span><span> </span><span class="annot"><a href="#local-6989586621679447417"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#OpRewriteM"><span class="hs-identifier hs-type">OpRewriteM</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447417"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.Builder.html#RegionBuilderT"><span class="hs-identifier hs-type">RegionBuilderT</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><a href="MLIR.AST.Rewrite.html#RewriteT"><span class="hs-identifier hs-type">RewriteT</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447417"><span class="hs-identifier hs-type">m</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><a href="MLIR.AST.Builder.html#BlockName"><span class="hs-identifier hs-type">BlockName</span></a></span></span><span>
</span><span id="line-82"></span><span id="applyOpRewriteBlock"><span class="annot"><span class="annottext">applyOpRewriteBlock :: OpRewriteM m -&gt; Block -&gt; RegionBuilderT (RewriteT m) Name
</span><a href="MLIR.AST.Rewrite.html#applyOpRewriteBlock"><span class="hs-identifier hs-var hs-var">applyOpRewriteBlock</span></a></span></span><span> </span><span id="local-6989586621679447318"><span class="annot"><span class="annottext">OpRewriteM m
</span><a href="#local-6989586621679447318"><span class="hs-identifier hs-var">rule</span></a></span></span><span> </span><span class="annot"><a href="MLIR.AST.html#Block"><span class="hs-identifier hs-type">Block</span></a></span><span class="hs-special">{</span><span id="local-6989586621679447315"><span id="local-6989586621679447316"><span id="local-6989586621679447317"><span class="annot"><span class="annottext">[(Name, Type)]
[Binding]
Name
blockBody :: Block -&gt; [Binding]
blockArgs :: Block -&gt; [(Name, Type)]
blockName :: Block -&gt; Name
blockBody :: [Binding]
blockArgs :: [(Name, Type)]
blockName :: Name
</span><a href="MLIR.AST.html#blockBody"><span class="hs-glyph hs-var hs-var hs-var hs-var hs-var hs-var">..</span></a></span></span></span></span><span class="hs-special">}</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-83"></span><span>  </span><span class="annot"><span class="annottext">BlockBuilderT (RewriteT m) EndOfBlock
-&gt; RegionBuilderT (RewriteT m) Name
forall (m :: * -&gt; *).
Monad m =&gt;
BlockBuilderT m EndOfBlock -&gt; RegionBuilderT m Name
</span><a href="MLIR.AST.Builder.html#buildBlock"><span class="hs-identifier hs-var">buildBlock</span></a></span><span> </span><span class="annot"><span class="annottext">(BlockBuilderT (RewriteT m) EndOfBlock
 -&gt; RegionBuilderT (RewriteT m) Name)
-&gt; BlockBuilderT (RewriteT m) EndOfBlock
-&gt; RegionBuilderT (RewriteT m) Name
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-84"></span><span>    </span><span class="hs-keyword">let</span><span> </span><span class="hs-special">(</span><span id="local-6989586621679447310"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679447310"><span class="hs-identifier hs-var">blockArgNames</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679447309"><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679447309"><span class="hs-identifier hs-var">blockArgTypes</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[(Name, Type)] -&gt; ([Name], [Type])
forall a b. [(a, b)] -&gt; ([a], [b])
</span><span class="hs-identifier hs-var">unzip</span></span><span> </span><span class="annot"><span class="annottext">[(Name, Type)]
</span><a href="#local-6989586621679447316"><span class="hs-identifier hs-var">blockArgs</span></a></span><span>
</span><span id="line-85"></span><span>    </span><span id="local-6989586621679447307"><span class="annot"><span class="annottext">[Value]
</span><a href="#local-6989586621679447307"><span class="hs-identifier hs-var">newBlockArgs</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">(Type -&gt; BlockBuilderT (RewriteT m) Value)
-&gt; [Type] -&gt; BlockBuilderT (RewriteT m) [Value]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="annot"><span class="annottext">Type -&gt; BlockBuilderT (RewriteT m) Value
forall (m :: * -&gt; *). MonadBlockBuilder m =&gt; Type -&gt; m Value
</span><a href="MLIR.AST.Builder.html#blockArgument"><span class="hs-identifier hs-var">blockArgument</span></a></span><span> </span><span class="annot"><span class="annottext">[Type]
</span><a href="#local-6989586621679447309"><span class="hs-identifier hs-var">blockArgTypes</span></a></span><span>
</span><span id="line-86"></span><span>    </span><span class="annot"><span class="annottext">ValueMapping
-&gt; BlockBuilderT (RewriteT m) EndOfBlock
-&gt; BlockBuilderT (RewriteT m) EndOfBlock
forall (m :: * -&gt; *) a.
MonadReader (ValueMapping, BlockMapping) m =&gt;
ValueMapping -&gt; m a -&gt; m a
</span><a href="MLIR.AST.Rewrite.html#extendValueMap"><span class="hs-identifier hs-var">extendValueMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Name, Value)] -&gt; ValueMapping
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(Name, Value)] -&gt; ValueMapping)
-&gt; [(Name, Value)] -&gt; ValueMapping
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Value] -&gt; [(Name, Value)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679447310"><span class="hs-identifier hs-var">blockArgNames</span></a></span><span> </span><span class="annot"><span class="annottext">[Value]
</span><a href="#local-6989586621679447307"><span class="hs-identifier hs-var">newBlockArgs</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(BlockBuilderT (RewriteT m) EndOfBlock
 -&gt; BlockBuilderT (RewriteT m) EndOfBlock)
-&gt; BlockBuilderT (RewriteT m) EndOfBlock
-&gt; BlockBuilderT (RewriteT m) EndOfBlock
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Binding] -&gt; BlockBuilderT (RewriteT m) EndOfBlock
</span><a href="#local-6989586621679447304"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621679447315"><span class="hs-identifier hs-var">blockBody</span></a></span><span>
</span><span id="line-87"></span><span>  </span><span class="hs-keyword">where</span><span>
</span><span id="line-88"></span><span>    </span><span id="local-6989586621679447304"><span class="annot"><span class="annottext">go :: [Binding] -&gt; BlockBuilderT (RewriteT m) EndOfBlock
</span><a href="#local-6989586621679447304"><span class="hs-identifier hs-var hs-var">go</span></a></span></span><span> </span><span id="local-6989586621679447303"><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621679447303"><span class="hs-identifier hs-var">bs</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621679447303"><span class="hs-identifier hs-var">bs</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-89"></span><span>      </span><span class="hs-special">[</span><span class="hs-special">]</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">BlockBuilderT (RewriteT m) EndOfBlock
forall (m :: * -&gt; *). Monad m =&gt; m EndOfBlock
</span><a href="MLIR.AST.Builder.html#terminateBlock"><span class="hs-identifier hs-var">terminateBlock</span></a></span><span>
</span><span id="line-90"></span><span>      </span><span class="hs-special">(</span><span class="hs-special">(</span><span class="annot"><a href="MLIR.AST.html#Bind"><span class="hs-identifier hs-type">Bind</span></a></span><span> </span><span id="local-6989586621679447300"><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679447300"><span class="hs-identifier hs-var">names</span></a></span></span><span> </span><span id="local-6989586621679447299"><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447299"><span class="hs-identifier hs-var">astOp</span></a></span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="hs-glyph hs-type">:</span></span><span> </span><span id="local-6989586621679447298"><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621679447298"><span class="hs-identifier hs-var">rest</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-91"></span><span>        </span><span id="local-6989586621679447297"><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447297"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">Operation -&gt; BlockBuilderT (RewriteT m) Operation
forall (m :: * -&gt; *).
MonadReader (ValueMapping, BlockMapping) m =&gt;
Operation -&gt; m Operation
</span><a href="MLIR.AST.Rewrite.html#substOp"><span class="hs-identifier hs-var">substOp</span></a></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447299"><span class="hs-identifier hs-var">astOp</span></a></span><span>
</span><span id="line-92"></span><span>        </span><span id="local-6989586621679447295"><span class="annot"><span class="annottext">RewriteResult
</span><a href="#local-6989586621679447295"><span class="hs-identifier hs-var">answer</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">OpRewriteM m
</span><a href="#local-6989586621679447318"><span class="hs-identifier hs-var">rule</span></a></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447297"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-93"></span><span>        </span><span id="local-6989586621679447294"><span class="annot"><span class="annottext">[Value]
</span><a href="#local-6989586621679447294"><span class="hs-identifier hs-var">newValues</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="hs-keyword">case</span><span> </span><span class="annot"><span class="annottext">RewriteResult
</span><a href="#local-6989586621679447295"><span class="hs-identifier hs-var">answer</span></a></span><span> </span><span class="hs-keyword">of</span><span>
</span><span id="line-94"></span><span>          </span><span class="annot"><a href="MLIR.AST.Rewrite.html#Replace"><span class="hs-identifier hs-type">Replace</span></a></span><span> </span><span id="local-6989586621679447293"><span class="annot"><span class="annottext">[Value]
</span><a href="#local-6989586621679447293"><span class="hs-identifier hs-var">newValues</span></a></span></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-95"></span><span>            </span><span class="annot"><span class="annottext">Bool
-&gt; BlockBuilderT (RewriteT m) () -&gt; BlockBuilderT (RewriteT m) ()
forall (f :: * -&gt; *). Applicative f =&gt; Bool -&gt; f () -&gt; f ()
</span><span class="hs-identifier hs-var">unless</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[Name] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679447300"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">Int -&gt; Int -&gt; Bool
forall a. Eq a =&gt; a -&gt; a -&gt; Bool
</span><span class="hs-operator hs-var">==</span></span><span> </span><span class="annot"><span class="annottext">[Value] -&gt; Int
forall (t :: * -&gt; *) a. Foldable t =&gt; t a -&gt; Int
</span><span class="hs-identifier hs-var">length</span></span><span> </span><span class="annot"><span class="annottext">[Value]
</span><a href="#local-6989586621679447293"><span class="hs-identifier hs-var">newValues</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(BlockBuilderT (RewriteT m) () -&gt; BlockBuilderT (RewriteT m) ())
-&gt; BlockBuilderT (RewriteT m) () -&gt; BlockBuilderT (RewriteT m) ()
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span>
</span><span id="line-96"></span><span>              </span><span class="annot"><span class="annottext">[Char] -&gt; BlockBuilderT (RewriteT m) ()
forall a. HasCallStack =&gt; [Char] -&gt; a
</span><span class="hs-identifier hs-var">error</span></span><span> </span><span class="annot"><span class="annottext">[Char]
</span><span class="hs-string">&quot;Rewrite rule returned an incorrect number of values&quot;</span></span><span>
</span><span id="line-97"></span><span>            </span><span class="annot"><span class="annottext">[Value] -&gt; BlockBuilderT (RewriteT m) [Value]
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">[Value]
</span><a href="#local-6989586621679447293"><span class="hs-identifier hs-var">newValues</span></a></span><span>
</span><span id="line-98"></span><span>          </span><span class="annot"><span class="annottext">RewriteResult
</span><a href="MLIR.AST.Rewrite.html#Traverse"><span class="hs-identifier hs-var">Traverse</span></a></span><span>          </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Operation -&gt; BlockBuilderT (RewriteT m) [Value]
</span><a href="#local-6989586621679447289"><span class="hs-identifier hs-var">opRewriteTraverse</span></a></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447297"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-99"></span><span>          </span><span class="annot"><span class="annottext">RewriteResult
</span><a href="MLIR.AST.Rewrite.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span>              </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><span class="annottext">Operation -&gt; BlockBuilderT (RewriteT m) [Value]
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *).
(MonadTrans t, MonadFix m,
 MonadBlockBuilder
   (t (ReaderT (ValueMapping, BlockMapping) (NameSupplyT m)))) =&gt;
Operation
-&gt; t (ReaderT (ValueMapping, BlockMapping) (NameSupplyT m)) [Value]
</span><a href="#local-6989586621679447288"><span class="hs-identifier hs-var">opRewriteSkip</span></a></span><span>     </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447297"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-100"></span><span>        </span><span class="annot"><span class="annottext">ValueMapping
-&gt; BlockBuilderT (RewriteT m) EndOfBlock
-&gt; BlockBuilderT (RewriteT m) EndOfBlock
forall (m :: * -&gt; *) a.
MonadReader (ValueMapping, BlockMapping) m =&gt;
ValueMapping -&gt; m a -&gt; m a
</span><a href="MLIR.AST.Rewrite.html#extendValueMap"><span class="hs-identifier hs-var">extendValueMap</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">[(Name, Value)] -&gt; ValueMapping
forall k a. Ord k =&gt; [(k, a)] -&gt; Map k a
</span><span class="hs-identifier hs-var">M.fromList</span></span><span> </span><span class="annot"><span class="annottext">([(Name, Value)] -&gt; ValueMapping)
-&gt; [(Name, Value)] -&gt; ValueMapping
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Name] -&gt; [Value] -&gt; [(Name, Value)]
forall a b. [a] -&gt; [b] -&gt; [(a, b)]
</span><span class="hs-identifier hs-var">zip</span></span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679447300"><span class="hs-identifier hs-var">names</span></a></span><span> </span><span class="annot"><span class="annottext">[Value]
</span><a href="#local-6989586621679447294"><span class="hs-identifier hs-var">newValues</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">(BlockBuilderT (RewriteT m) EndOfBlock
 -&gt; BlockBuilderT (RewriteT m) EndOfBlock)
-&gt; BlockBuilderT (RewriteT m) EndOfBlock
-&gt; BlockBuilderT (RewriteT m) EndOfBlock
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">[Binding] -&gt; BlockBuilderT (RewriteT m) EndOfBlock
</span><a href="#local-6989586621679447304"><span class="hs-identifier hs-var">go</span></a></span><span> </span><span class="annot"><span class="annottext">[Binding]
</span><a href="#local-6989586621679447298"><span class="hs-identifier hs-var">rest</span></a></span><span>
</span><span id="line-101"></span><span>
</span><span id="line-102"></span><span>    </span><span id="local-6989586621679447289"><span class="annot"><span class="annottext">opRewriteTraverse :: Operation -&gt; BlockBuilderT (RewriteT m) [Value]
</span><a href="#local-6989586621679447289"><span class="hs-identifier hs-var hs-var">opRewriteTraverse</span></a></span></span><span> </span><span id="local-6989586621679447287"><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447287"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-103"></span><span>      </span><span id="local-6989586621679447286"><span class="annot"><span class="annottext">[Region]
</span><a href="#local-6989586621679447286"><span class="hs-identifier hs-var">newRegions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region]
-&gt; BlockBuilderT (RewriteT m) [Region]
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region]
 -&gt; BlockBuilderT (RewriteT m) [Region])
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region]
-&gt; BlockBuilderT (RewriteT m) [Region]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Region
 -&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) Region)
-&gt; [Region]
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OpRewriteM m
-&gt; Region
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) Region
forall (m :: * -&gt; *).
MonadFix m =&gt;
OpRewriteM m -&gt; Region -&gt; RewriteT m Region
</span><a href="MLIR.AST.Rewrite.html#applyOpRewriteRegion"><span class="hs-identifier hs-var">applyOpRewriteRegion</span></a></span><span> </span><span class="annot"><span class="annottext">OpRewriteM m
</span><a href="#local-6989586621679447318"><span class="hs-identifier hs-var">rule</span></a></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Region]
 -&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region])
-&gt; [Region]
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operation -&gt; [Region]
forall operand. AbstractOperation operand -&gt; [Region]
</span><a href="MLIR.AST.html#opRegions"><span class="hs-identifier hs-var hs-var">opRegions</span></a></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447287"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-104"></span><span>      </span><span class="annot"><span class="annottext">Operation -&gt; BlockBuilderT (RewriteT m) [Value]
forall (m :: * -&gt; *). MonadBlockBuilder m =&gt; Operation -&gt; m [Value]
</span><a href="MLIR.AST.Builder.html#emitOp"><span class="hs-identifier hs-var">emitOp</span></a></span><span> </span><span class="annot"><span class="annottext">(Operation -&gt; BlockBuilderT (RewriteT m) [Value])
-&gt; Operation -&gt; BlockBuilderT (RewriteT m) [Value]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447287"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">opRegions :: [Region]
</span><a href="MLIR.AST.html#opRegions"><span class="hs-identifier hs-var">opRegions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Region]
</span><a href="#local-6989586621679447286"><span class="hs-identifier hs-var">newRegions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">opOperands :: [Name]
</span><a href="MLIR.AST.html#opOperands"><span class="hs-identifier hs-var">opOperands</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Value] -&gt; [Name]
</span><a href="MLIR.AST.Builder.html#operands"><span class="hs-identifier hs-var">operands</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operation -&gt; [Value]
forall operand. AbstractOperation operand -&gt; [operand]
</span><a href="MLIR.AST.html#opOperands"><span class="hs-identifier hs-var hs-var">opOperands</span></a></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447287"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-105"></span><span>
</span><span id="line-106"></span><span>    </span><span id="local-6989586621679447288"><span class="annot"><span class="annottext">opRewriteSkip :: Operation
-&gt; t (ReaderT (ValueMapping, BlockMapping) (NameSupplyT m)) [Value]
</span><a href="#local-6989586621679447288"><span class="hs-identifier hs-var hs-var">opRewriteSkip</span></a></span></span><span> </span><span id="local-6989586621679447281"><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447281"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-107"></span><span>      </span><span class="hs-comment">-- Note that we still have to traverse the subregions in case they close-over</span><span>
</span><span id="line-108"></span><span>      </span><span class="hs-comment">-- any values that have had their names updated.</span><span>
</span><span id="line-109"></span><span>      </span><span id="local-6989586621679447280"><span class="annot"><span class="annottext">[Region]
</span><a href="#local-6989586621679447280"><span class="hs-identifier hs-var">newRegions</span></a></span></span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region]
-&gt; t (ReaderT (ValueMapping, BlockMapping) (NameSupplyT m))
     [Region]
forall (t :: (* -&gt; *) -&gt; * -&gt; *) (m :: * -&gt; *) a.
(MonadTrans t, Monad m) =&gt;
m a -&gt; t m a
</span><span class="hs-identifier hs-var">lift</span></span><span> </span><span class="annot"><span class="annottext">(ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region]
 -&gt; t (ReaderT (ValueMapping, BlockMapping) (NameSupplyT m))
      [Region])
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region]
-&gt; t (ReaderT (ValueMapping, BlockMapping) (NameSupplyT m))
     [Region]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">(Region
 -&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) Region)
-&gt; [Region]
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region]
forall (t :: * -&gt; *) (m :: * -&gt; *) a b.
(Traversable t, Monad m) =&gt;
(a -&gt; m b) -&gt; t a -&gt; m (t b)
</span><span class="hs-identifier hs-var">mapM</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">OpRewriteM m
-&gt; Region
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) Region
forall (m :: * -&gt; *).
MonadFix m =&gt;
OpRewriteM m -&gt; Region -&gt; RewriteT m Region
</span><a href="MLIR.AST.Rewrite.html#applyOpRewriteRegion"><span class="hs-identifier hs-var">applyOpRewriteRegion</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockBuilderT
  (ReaderT (ValueMapping, BlockMapping) (NameSupplyT m))
  RewriteResult
-&gt; OpRewriteM m
forall a b. a -&gt; b -&gt; a
</span><span class="hs-identifier hs-var">const</span></span><span> </span><span class="annot"><span class="annottext">(BlockBuilderT
   (ReaderT (ValueMapping, BlockMapping) (NameSupplyT m))
   RewriteResult
 -&gt; OpRewriteM m)
-&gt; BlockBuilderT
     (ReaderT (ValueMapping, BlockMapping) (NameSupplyT m))
     RewriteResult
-&gt; OpRewriteM m
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">RewriteResult
-&gt; BlockBuilderT
     (ReaderT (ValueMapping, BlockMapping) (NameSupplyT m))
     RewriteResult
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">RewriteResult
</span><a href="MLIR.AST.Rewrite.html#Skip"><span class="hs-identifier hs-var">Skip</span></a></span><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Region]
 -&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region])
-&gt; [Region]
-&gt; ReaderT (ValueMapping, BlockMapping) (NameSupplyT m) [Region]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operation -&gt; [Region]
forall operand. AbstractOperation operand -&gt; [Region]
</span><a href="MLIR.AST.html#opRegions"><span class="hs-identifier hs-var hs-var">opRegions</span></a></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447281"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-110"></span><span>      </span><span class="annot"><span class="annottext">Operation
-&gt; t (ReaderT (ValueMapping, BlockMapping) (NameSupplyT m)) [Value]
forall (m :: * -&gt; *). MonadBlockBuilder m =&gt; Operation -&gt; m [Value]
</span><a href="MLIR.AST.Builder.html#emitOp"><span class="hs-identifier hs-var">emitOp</span></a></span><span> </span><span class="annot"><span class="annottext">(Operation
 -&gt; t (ReaderT (ValueMapping, BlockMapping) (NameSupplyT m))
      [Value])
-&gt; Operation
-&gt; t (ReaderT (ValueMapping, BlockMapping) (NameSupplyT m)) [Value]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447281"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">opRegions :: [Region]
</span><a href="MLIR.AST.html#opRegions"><span class="hs-identifier hs-var">opRegions</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Region]
</span><a href="#local-6989586621679447280"><span class="hs-identifier hs-var">newRegions</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">opOperands :: [Name]
</span><a href="MLIR.AST.html#opOperands"><span class="hs-identifier hs-var">opOperands</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Value] -&gt; [Name]
</span><a href="MLIR.AST.Builder.html#operands"><span class="hs-identifier hs-var">operands</span></a></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">Operation -&gt; [Value]
forall operand. AbstractOperation operand -&gt; [operand]
</span><a href="MLIR.AST.html#opOperands"><span class="hs-identifier hs-var hs-var">opOperands</span></a></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447281"><span class="hs-identifier hs-var">op</span></a></span><span class="hs-special">)</span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-111"></span><span>
</span><span id="line-112"></span><span id="local-6989586621679447397"><span class="annot"><a href="MLIR.AST.Rewrite.html#substOp"><span class="hs-identifier hs-type">substOp</span></a></span><span> </span><span class="hs-glyph">::</span><span> </span><span class="annot"><span class="hs-identifier hs-type">MonadReader</span></span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#BlockAndValueMapping"><span class="hs-identifier hs-type">BlockAndValueMapping</span></a></span><span> </span><span class="annot"><a href="#local-6989586621679447397"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><span class="annot"><a href="MLIR.AST.html#Operation"><span class="hs-identifier hs-type">AST.Operation</span></a></span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="annot"><a href="#local-6989586621679447397"><span class="hs-identifier hs-type">m</span></a></span><span> </span><span class="annot"><a href="MLIR.AST.Rewrite.html#Operation"><span class="hs-identifier hs-type">Operation</span></a></span></span><span>
</span><span id="line-113"></span><span id="substOp"><span class="annot"><span class="annottext">substOp :: Operation -&gt; m Operation
</span><a href="MLIR.AST.Rewrite.html#substOp"><span class="hs-identifier hs-var hs-var">substOp</span></a></span></span><span> </span><span id="local-6989586621679447278"><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447278"><span class="hs-identifier hs-var">op</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-keyword">do</span><span>
</span><span id="line-114"></span><span>  </span><span class="hs-special">(</span><span id="local-6989586621679447277"><span class="annot"><span class="annottext">ValueMapping
</span><a href="#local-6989586621679447277"><span class="hs-identifier hs-var">valueMap</span></a></span></span><span class="hs-special">,</span><span> </span><span id="local-6989586621679447276"><span class="annot"><span class="annottext">BlockMapping
</span><a href="#local-6989586621679447276"><span class="hs-identifier hs-var">blockMap</span></a></span></span><span class="hs-special">)</span><span> </span><span class="hs-glyph">&lt;-</span><span> </span><span class="annot"><span class="annottext">m (ValueMapping, BlockMapping)
forall r (m :: * -&gt; *). MonadReader r m =&gt; m r
</span><span class="hs-identifier hs-var">ask</span></span><span>
</span><span id="line-115"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679447274"><span class="annot"><span class="annottext">newOperands :: [Value]
</span><a href="#local-6989586621679447274"><span class="hs-identifier hs-var hs-var">newOperands</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Value) -&gt; [Name] -&gt; [Value]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">ValueMapping
</span><a href="#local-6989586621679447277"><span class="hs-identifier hs-var">valueMap</span></a></span><span> </span><span class="annot"><span class="annottext">ValueMapping -&gt; Name -&gt; Value
forall k a. Ord k =&gt; Map k a -&gt; k -&gt; a
</span><span class="hs-operator hs-var">M.!</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Name] -&gt; [Value]) -&gt; [Name] -&gt; [Value]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operation -&gt; [Name]
forall operand. AbstractOperation operand -&gt; [operand]
</span><a href="MLIR.AST.html#opOperands"><span class="hs-identifier hs-var hs-var">opOperands</span></a></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447278"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-116"></span><span>  </span><span class="hs-keyword">let</span><span> </span><span id="local-6989586621679447272"><span class="annot"><span class="annottext">newSuccessors :: [Name]
</span><a href="#local-6989586621679447272"><span class="hs-identifier hs-var hs-var">newSuccessors</span></a></span></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">(Name -&gt; Name) -&gt; [Name] -&gt; [Name]
forall (f :: * -&gt; *) a b. Functor f =&gt; (a -&gt; b) -&gt; f a -&gt; f b
</span><span class="hs-identifier hs-var">fmap</span></span><span> </span><span class="hs-special">(</span><span class="annot"><span class="annottext">BlockMapping
</span><a href="#local-6989586621679447276"><span class="hs-identifier hs-var">blockMap</span></a></span><span> </span><span class="annot"><span class="annottext">BlockMapping -&gt; Name -&gt; Name
forall k a. Ord k =&gt; Map k a -&gt; k -&gt; a
</span><span class="hs-operator hs-var">M.!</span></span><span class="hs-special">)</span><span> </span><span class="annot"><span class="annottext">([Name] -&gt; [Name]) -&gt; [Name] -&gt; [Name]
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operation -&gt; [Name]
forall operand. AbstractOperation operand -&gt; [Name]
</span><a href="MLIR.AST.html#opSuccessors"><span class="hs-identifier hs-var hs-var">opSuccessors</span></a></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447278"><span class="hs-identifier hs-var">op</span></a></span><span>
</span><span id="line-117"></span><span>  </span><span class="annot"><span class="annottext">Operation -&gt; m Operation
forall (m :: * -&gt; *) a. Monad m =&gt; a -&gt; m a
</span><span class="hs-identifier hs-var">return</span></span><span> </span><span class="annot"><span class="annottext">(Operation -&gt; m Operation) -&gt; Operation -&gt; m Operation
forall a b. (a -&gt; b) -&gt; a -&gt; b
</span><span class="hs-operator hs-var">$</span></span><span> </span><span class="annot"><span class="annottext">Operation
</span><a href="#local-6989586621679447278"><span class="hs-identifier hs-var">op</span></a></span><span> </span><span class="hs-special">{</span><span> </span><span class="annot"><span class="annottext">opOperands :: [Value]
</span><a href="MLIR.AST.html#opOperands"><span class="hs-identifier hs-var">opOperands</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Value]
</span><a href="#local-6989586621679447274"><span class="hs-identifier hs-var">newOperands</span></a></span><span class="hs-special">,</span><span> </span><span class="annot"><span class="annottext">opSuccessors :: [Name]
</span><a href="MLIR.AST.html#opSuccessors"><span class="hs-identifier hs-var">opSuccessors</span></a></span><span> </span><span class="hs-glyph">=</span><span> </span><span class="annot"><span class="annottext">[Name]
</span><a href="#local-6989586621679447272"><span class="hs-identifier hs-var">newSuccessors</span></a></span><span> </span><span class="hs-special">}</span><span>
</span><span id="line-118"></span><span>
</span><span id="line-119"></span><span class="hs-comment">-- TODO(apaszke): Multi-op-patterns. Sketch:</span><span>
</span><span id="line-120"></span><span class="hs-comment">--</span><span>
</span><span id="line-121"></span><span class="hs-comment">-- type OperationExpr = AbstractOperation Value</span><span>
</span><span id="line-122"></span><span class="hs-comment">-- data Value = BlockArgument Builder.Value | OperationResult Builder.Value Int OperationExpr</span><span>
</span><span id="line-123"></span><span class="hs-comment">--</span><span>
</span><span id="line-124"></span><span class="hs-comment">-- instance Builder.IsValue Value where</span><span>
</span><span id="line-125"></span><span class="hs-comment">--   getValue (BlockArgument val) = val</span><span>
</span><span id="line-126"></span><span class="hs-comment">--   getValue (Result val _ _)    = val</span><span>
</span><span id="line-127"></span><span class="hs-comment">--</span><span>
</span><span id="line-128"></span><span class="hs-comment">-- pattern Result :: Int -&gt; OperationExpr -&gt; Value</span><span>
</span><span id="line-129"></span><span class="hs-comment">-- pattern Result idx opExpr &lt;- OperationResult _ idx opExpr</span><span>
</span><span id="line-130"></span><span class="hs-comment">--</span><span>
</span><span id="line-131"></span><span class="hs-comment">-- pattern Result0 :: OperationExpr -&gt; Value</span><span>
</span><span id="line-132"></span><span class="hs-comment">-- pattern Result0 opExpr &lt;- OperationResult _ 0 opExpr</span><span>
</span><span id="line-133"></span><span class="hs-comment">--</span><span>
</span><span id="line-134"></span><span class="hs-comment">-- asOperationExpr :: MonadRewrite m =&gt; Operation -&gt; m OperationExpr</span><span>
</span><span id="line-135"></span><span class="hs-comment">-- asOperationExpr = undefined</span><span>
</span><span id="line-136"></span><span class="hs-comment">--</span><span>
</span><span id="line-137"></span><span class="hs-comment">-- TODO(apaszke): Multi-op-patterns removals with multi-op-patterns. Sketch:</span><span>
</span><span id="line-138"></span><span class="hs-comment">--</span><span>
</span><span id="line-139"></span><span class="hs-comment">-- erase :: MonadRewrite m =&gt; Operation -&gt; m ()</span><span>
</span><span id="line-140"></span><span class="hs-comment">-- erase = undefined</span><span>
</span><span id="line-141"></span></pre></body></html>